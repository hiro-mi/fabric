# Membership

[IDに関するドキュメント](../identity/identity.html)を読んでいれば、PKIが信頼のチェーンを通じて検証可能なIDを提供する方法を知っているでしょう。
次に、これらのIDを使用してブロックチェーンネットワークの信頼できるメンバーを表す方法を見てみましょう。

これは、 **メンバーシップサービス** プロバイダー（MSP:Membership Service Provider）が登場するところです。
MSPは、**組織などの信頼ドメインのメンバーを定義する信頼できるルートCAと中間CAを識別します**。それは、メンバーのIDを一覧表示するか、 どのCAがメンバーに対して有効なIDを発行する権限を与えられているか、（または、よくあることですが）両方の組み合わせを通じて行われます。

MSPの機能は、単にネットワーク参加者またはチャネルのメンバーをリストするだけではありません。
MSPは、アクターがMSPが表す組織の範囲内で果たす特定の役割（管理者、またはサブ組織グループのメンバーなど）を識別します。
そして、MSPはネットワークおよびチャンネルの文脈でアクセス特権を定義するための基礎を設定します。（チャンネル管理者、リーダー、ライターなど）。

MSPの設定は、対応する組織のメンバーが参加するすべてのチャネルに（ **チャネルMSP** の形式で）通知されます。
チャネルMSPにくわえて、Peer、Orderer、およびクライアントは **ローカルMSP** を維持します。
ローカルMSPは、チャネルのコンテキスト外でメンバーメッセージを認証し、特定のコンポーネントに対するパーミッションを定義します（たとえば、ピアにチェーンコードをインストールできる人は誰かということ）。

さらに、MSPでは、取り消されたIDのリストを識別できます（[IDのドキュメント](../identity/identity.html)で説明されています）が、
そのプロセスがMSPにどのように拡張されるかについて説明します。

ローカルおよびチャネルMSPについては、後ほど詳しく説明します。 
ここでは、MSPが一般的に行うことを見てみましょう。

### 組織へのMSPのマッピング

**組織** は、メンバーの管理グループです。
これは、多国籍企業のような大きなものでも、フラワーショップのような小さなものでもかまいません。
組織（または**orgs**）で最も重要なのは、単一のMSPでメンバーを管理することです。
これは、後で説明するX.509証明書で定義されている組織の概念とは異なることに注意してください。

組織とそのMSPの排他的関係により、組織にちなんでMSPに名前を付けることが賢明です。
これは、ほとんどのポリシー構成で採用されている慣習です。
たとえば、組織`ORG1`には、`ORG1-MSP`などのMSPがあります。
場合によっては、組織が複数のメンバーシップグループを必要とする場合があります。
たとえば、チャネルが組織間で非常に異なるビジネス機能を実行するために使用される場合です。
これらの場合、複数のMSPを持ち、それに応じて名前を付けることは理にかなっています
（例：`ORG2-MSP-NATIONAL`および`ORG2-MSP-GOVERNMENT`のような場合。
`ORG2`内の`NATIONAL`販売チャネルは`GOVERNMENT`の規制チャネルと比較して異なるメンバーシップのrootsを反映しています。

![MSP1](./membership.diagram.3.png)

*組織の2つの異なるMSP設定。
最初の設定は、MSPと組織の間の一般的な関係を示しています。
単一のMSPは、組織のメンバーのリストを定義します。 
2番目の設定では、異なるMSPを使用して、国内、国際、および政府の所属を持つさまざまな組織グループを表します*

#### 組織単位とMSP

多くの場合、組織は複数の**組織単位**（OUs:organization units）に分割され、各組織単位には特定の責任があります。
たとえば、`ORG1`組織には`ORG1-MANUFACTURING` OUと`ORG1-DISTRIBUTION` OUの両方があり、これらの個別の事業部門を反映している場合があります。
CAがX.509証明書を発行する場合、証明書の`OU`フィールドは、IDが属する事業部門を指定します。

OUがブロックチェーンネットワークのメンバーと見なされる組織の一部を制御するのにどのように役立つかについては、後で説明します。
たとえば、`ORG1-MANUFACTURING` OUのIDのみがチャネルにアクセスできますが、`ORG1-DISTRIBUTION`はできません。

最後に、これはOUのわずかな誤用ですが、コンソーシアム内の異なる組織が互いを区別するために使用することがあります。
そのような場合、異なる組織は、信頼チェーンに同じルートCAと中間CAを使用しますが、`OU`フィールドを割り当てて各組織のメンバーを識別します。
また、これを実現するためにMSPを構成する方法も確認します。

### ローカルMSP、チャンネルMSP

MSPは、ブロックチェーンネットワークの2つの場所に表示されます。
チャネル設定（**チャネルMSP**）と、アクターの設定（**ローカルMSP**）です。
**ローカルMSPは、クライアント（ユーザー）およびノード（ピアおよびOrderer）に対して定義されます。**
ノードのローカルMSPは、そのノードのアクセス許可（ピア管理者など）を定義します。
ユーザーのローカルMSPにより、ユーザー側は、そのトランザクションでチャネルのメンバー（チェーンコードトランザクションなど）として、またはシステムへの特定のロールの所有者（たとえば設定トランザクションにおける組織管理者）として自身を認証できます。

**すべてのノードとユーザーにはローカルMSPが定義されている必要があります。**
これにより、誰がどのレベルで管理権限または参加権限を持っているかを定義します。（ピア管理者は必ずしもチャネル管理者であるとは限りません）

対照的に、**チャネルMSPは、チャネルレベルで管理権限と参加権限を定義**します。
チャネルに参加するすべての組織には、MSPが定義されている必要があります。
チャンネルのピアと注文者は、すべてチャンネルMSPの同じビューを共有するため、チャンネル参加者を正しく認証できます。
つまり、組織がチャネルに参加したい場合、組織のメンバーの信頼チェーンを組み込んだMSPをチャネル構成に含める必要があります。
そうしないと、この組織のIDから発生したトランザクションは拒否されます。

ここでのローカルMSPとチャネルMSPの主な違いは、それらがどのように機能するかではありません。
どちらもIDを役割に変えるものであり、**MSPのスコープ**の違いが重要なのです。

<a name="msp2img"></a>

![MSP2](./membership.diagram.4.png)

*ローカルおよびチャネルMSP。
各ピアの信頼ドメイン（組織など）は、ピアのローカルMSP（ORG1またはORG2など）によって定義されます。
チャネル上の組織の表現は、組織のMSPをチャネル構成に追加することにより実現されます。
たとえば、この図のチャネルは、ORG1とORG2の両方によって管理されています。
ネットワーク、Orderer、およびユーザーにも同様の原則が適用されますが、簡単にするためにここでは示していません。*

[上の図に示すように](#msp2img)、ブロックチェーン管理者がスマートコントラクトをインストールしてインスタンス化するときに何が起こるかを見ると、
ローカルMSPおよびチャネルMSPがどのように使用されているかを確認すると便利です。

管理者`B`は、`RCA1`によって発行され、ローカルMSPに保存されたIDでピアに接続します。 
`B`がピアにスマートコントラクトをインストールしようとすると、ピアはローカルMSP、`ORG1-MSP`をチェックして、`B`のIDが実際に`ORG1`のメンバーであることを確認します。
検証が成功すると、インストールコマンドが正常に完了します。
その後、`B`は、チャネルでスマートコントラクトをインスタンス化したいと考えています。
これはチャネル操作であるため、チャネル上のすべての組織がそれに同意する必要があります。
したがって、ピアはこのコマンドを正常にコミットする前に、チャネルのMSPを確認する必要があります。
（他のことも起こりますが、今のところは上記に集中してください。）

**ローカルMSPは、それらが適用されるノードまたはユーザーのファイルシステムでのみ定義されます。**
したがって、物理的および論理的には、ノードまたはユーザーごとに1つのローカルMSPのみが存在します。
ただし、チャネルMSPはチャネル内のすべてのノードで使用できるため、チャネル設定で一度論理的に定義されます。
**ただし、チャネルMSPは、チャネル内のすべてのノードのファイルシステムでもインスタンス化され、コンセンサスを介して同期が維持されます。**
そのため、すべてのノードのローカルファイルシステムに各チャネルMSPのコピーがありますが、論理的にはチャネルMSPはチャネルまたはネットワークに存在し、維持されます。

### MSP Levels

チャネルMSPとローカルMSPが分割されていることは、ローカルリソース（ピアまたはOrdererノードなど）と、チャネルリソース（チャネルまたはネットワークレベルで動作する台帳、スマートコントラクト、コンソーシアムなど）を管理する組織のニーズを反映しています。
これらのMSPが異なる **レベル** にあると考えると便利です。
**上位レベルのMSPはネットワーク管理の懸念に関連し、下位レベルのMSPは、プライベートリソースの管理のためにIDを取り扱います**。
MSPは、管理のすべてのレベルで必須です。MSPは、ネットワーク、チャネル、ピア、Orderer、およびユーザーに対して定義する必要があります。

![MSP3](./membership.diagram.2.png)

*MSPレベル。
PeerとOrdererのMSPはローカルですが、チャネル（ネットワーク構成チャネルを含む）のMSPはそのチャネルのすべての参加者で共有されます。
この図では、ネットワーク構成チャネルはORG1によって管理されていますが、別のアプリケーションチャネルはORG1およびORG2によって管理できます。
ピアはORG2のメンバーであり、ORG2によって管理されますが、ORG1は図のOrdererを管理します。
ORG1はRCA1のIDを信頼しますが、ORG2はRCA2のIDを信頼します。
これらは管理IDであり、これらのコンポーネントを誰が管理できるかを反映していることに注意してください。
そのため、ORG1がネットワークを管理している間、ORG2.MSPはネットワーク定義に存在します。*

 * **Network MSP：** ネットワークの構成は、参加組織のMSPを定義することにより、ネットワークのメンバーを定義します。
 また、これらのメンバーの誰が管理タスク（チャネルの作成など）を実行する権限を与えます。

 * **Channel MSP：** チャネルがそのメンバーのMSPを個別に維持することが重要です。
チャネルは、組織の特定のセット間でプライベートな通信を提供し、これを通じて、組織は管理制御を行います。
そのチャネルのMSPのコンテキストで解釈されるチャネルポリシーは、チャネル上の特定のアクションに参加する権限を持つユーザーを定義します。
(たとえば、組織の追加やチェーンコードのインスタンス化など)
チャネルを管理する権限とネットワーク構成チャネル（などの他のチャネルも含む）を管理する機能は、とくに関連しているわけではないことに注意してください。
管理される権利は、管理されているものの範囲内に存在します。
（ルールが別の方法で記述されていない限り、以下の`ROLE`属性の説明を参照してください）

 * **Peer MSP：** このローカルMSPは各ピアのファイルシステムで定義され、各ピアに単一のMSPインスタンスがあります。
概念的には、チャネルMSPとまったく同じ機能を実行しますが、それが定義されているピアにのみ適用されるという制限があります。
ピアのローカルMSPを使用して権限を評価するアクションの例は、ピアへのチェーンコードのインストールです。

 * **Orderer MSP:** Peer MSPと同様に、OrdererのLocal MSPもノードのファイルシステムで定義され、そのノードにのみ適用されます。
Peer nodeと同様に、Ordererも単一の組織によって所有されているため、Ordererは信頼できるアクターまたはノードをリストアップする単一のMSPを持っています。

### MSPの構造

これまで、MSPの最も重要な要素は、それぞれの組織でアクターまたはノードのメンバーシップを確立するために使用されるルートCAまたは中間CAの仕様であることがわかりました。
ただし、これらの2つと組み合わせて使用して、メンバーシップ機能を支援する要素がさらにあります。

![MSP4](./membership.diagram.5.png)

*上の図は、ローカルMSPが、どのようにローカルファイルシステムに保存されるかを示しています。
チャネルMSPは、このように物理的に構造化されていませんが、チャネルMSPについて考えるのに役立ちます。*

ご覧のとおり、MSPには9つの要素があります。 
これらの要素はディレクトリ構造で考えるのが最も簡単です。
MSP名はルートフォルダ名で、各サブフォルダはMSP構成の異なる要素を表します。

これらのフォルダについてもう少し詳しく説明し、それらが重要である理由を見てみましょう。

* **Root CAs:** このフォルダーには、MSPによって表される組織によって信頼されているルートCAの自己署名X.509証明書のリストが含まれています。
  このMSPフォルダーには、少なくとも1つのルートCA X.509証明書が必要です。

  これは、対応する組織のメンバーと見なされるために他のすべての証明書を取得する必要があるCAを識別するため、最も重要なフォルダーです。

* **Intermediate CAs:** このフォルダーには、この組織によって信頼されている中間CAのX.509証明書のリストが含まれています。 
  各証明書は、MSPのルートCAの1つ、または信頼されたルートCAとチェーンでつながっている中間CAによって、署名される必要があります。

  中間CAは、組織の別の下位区分（`ORG1`の`ORG1-MANUFACTURING`および`ORG1-DISTRIBUTION`のように）または組織自体（商用CAが組織のID管理に活用される場合など）を表す場合があります。 
  後者の場合、中間CAを使用して組織の下位区分を表すことができます。 
  [ここでは、MSP設定のベストプラクティスに関する詳細情報を見つけることができます。](../msp.html) 
  中間CAがないネットワークが機能している可能性があることに注意してください。
  この場合、このフォルダーは空になります。

  ルートCAフォルダーと同様に、このフォルダーは、組織のメンバーと見なされるために証明書を発行する必要があるCAを定義します。


* **Organizational Units (OUs):** これらは`$FABRIC_CFG_PATH/msp/config.yaml`ファイルに一覧で記載され、このMSPによって表される組織の一部であると考えられる組織単位のリストが含まれています。
  これは、組織のメンバーを、特定のOUを持つID（MSP指定CAのいずれかによって署名された）を保持するメンバーに制限する場合に特に役立ちます。

  OUの指定はオプションです。
  OUがリストされていない場合、MSPの一部であるすべてのID（ルートCAおよび中間CAフォルダーによって識別される）は、組織のメンバーと見なされます。


* **Administrators:** このフォルダーには、この組織の管理者の役割を持つアクターを定義するIDのリストが含まれています。
  標準のMSPタイプの場合、このリストには1つ以上のX.509証明書が必要です。

  アクターが管理者の役割を持っているからといって、特定のリソースを管理できるわけではないことに注意してください。システムの管理に関して特定のIDが持つ実際の能力は、システムリソースを管理するポリシーによって決まります。
  たとえば、チャネルポリシーでは、`ORG1-MANUFACTURING`管理者には新しい組織をチャネルに追加する権限があり、`ORG1-DISTRIBUTION`管理者にはそのような権限がないことを指定できます。

  X.509証明書には`ROLE`属性（アクターが`admin`であることを指定するなど）がありますが、これはブロックチェーンネットワークではなく組織内のアクターの役割を指します。
  これは、`OU`属性の目的に似ています。定義されている場合は、組織内のアクターの場所を指します。

 `ROLE`属性を使用してチャネルレベルで管理者権限を付与できます。
 それは、そのチャネルのポリシーが、特定の組織（または複数の組織）の管理者が、特定のチャネル機能（チェーンコードのインスタンス化など）を実行できるように、記述されているような場合となります。
  このようにして、組織の役割により、ネットワークの役割を付与できます。


* **Revoked Certificates:** アクターのIDが取り消された場合、ID自体ではなくIDに関する識別情報がこのフォルダーに保持されます。
  X.509ベースのIDの場合、これらの識別子はサブジェクトキー識別子（SKI）と機関アクセス識別子（AKI）として知られる文字列のペアです。
  X.509証明書を使用するたびにチェックされ、証明書が失効していないことが確認されます。

  このリストは、概念的にはCAの証明書失効リスト（CRL:Certificate Revocation List）と同じですが、組織からのメンバーシップの失効にも関連しています。
  結果として、ローカルまたはチャネルのMSPの管理者は、発行された失効証明書をCAの更新されたCRLに通知することにより、アクターまたはノードを組織から迅速に失効させることができます。
  この「リストのリスト（CAのCRLに通知するためのCRL）」はオプションです。
  証明書が取り消されると、データが入力されます。  


* **Node Identity:** このフォルダーには、ノードのIDが含まれています。
  つまり、これは暗号化された何かしらのもので、`KeyStore`のコンテンツと組み合わせ、ノードがチャネルおよびネットワークの他の参加者に送信されるメッセージで自身を認証できるようなものです。
  X.509ベースのIDの場合、このフォルダーには**X.509証明書**が含まれています。
  これは、たとえば、ピアが承認したことを示すためにピアがtransaction proposal responseに入れる証明書であり、検証時に結果のトランザクションのendorsement policyと照合して確認できます。

  このフォルダーはローカルMSPに必須であり、ノードに対して1つのX.509証明書が必要です。
  チャネルMSPには使用されません。


* **`KeyStore` for Private Key:** このフォルダーは、ピアまたは注文者ノードのローカルMSP（またはクライアントのローカルMSP）に対して定義され、ノードの**署名キー（秘密鍵）**が含まれます。
  このキーは、**ノードID**フォルダーに含まれるノードのIDと暗号的に一致し、データの署名に使用されます。
  たとえば、endorsement phaseの一部として、transaction proposal responseに署名するために使用されます。

  このフォルダーはローカルMSPに必須であり、秘密鍵を1つだけ含める必要があります。
  明らかに、このフォルダーへのアクセスは、ピアの管理責任を持つユーザーのIDのみに制限する必要があります。

  **チャネルMSP**の構成にはこのフォルダーは含まれません。
  それは、チャネルMSPは署名機能ではなくID検証機能を提供することのみを目的としているためです。


* **TLS Root CA:** このフォルダーには、この組織によって信頼されているルートCAの自己署名X.509証明書のリストが含まれおり、**TLS通信のために利用されます**。
  TLS通信の例としては、PeerがOrdererに接続して台帳の更新を受信できるようにする必要があるような場合です。

  MSP TLS情報は、ネットワーク内のノードに関連しています。つまり、ネットワークを消費するアプリケーションや管理ではなく、PeerとOrdererです。

  このフォルダーには、少なくとも1つのTLSルートCA X.509証明書が必要です。


* **TLS Intermediate CA:** このフォルダーには、中間CA証明書のリストが含まれています。
  CAはこのMSPによって表される組織によって信頼されており、**TLS通信のために利用されます**。
  このフォルダーは、組織のTLS証明書に商用CAが使用される場合に特に役立ちます。
  メンバーシップ中間CAと同様に、中間TLS CAの指定はオプションです。
  
  TLSの詳細については、[ここをクリックしてください](../enable_tls.html)。
  
このドキュメントと[IDに関するドキュメント](../identity/identity.html)を読んだことがある場合は、Hyperledger FabricでIDとメンバーシップがどのように機能するかを十分に把握しているはずです。
PKIとMSPを使用して、ブロックチェーンネットワークで協力しているアクターを識別する方法を見てきました。
MSPの物理的および論理的な構造に加えて、証明書、公開/秘密鍵、および信頼のルートの仕組みを学びました。

<!---
Licensed under Creative Commons Attribution 4.0 International License https://creativecommons.org/licenses/by/4.0/
-->
